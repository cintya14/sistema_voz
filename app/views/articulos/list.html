{% extends "base.html" %}

{% block title %}Listado de Artículos{% endblock %}

{% block content %}
<div class="container py-3">
    <div class="row justify-content-center">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h1 class="h3 mb-0"><i class="bi bi-box-seam me-2"></i>Listado de Artículos</h1>
                    <div class="d-flex">
                        <a href="{{ url_for('articulos_bp.add_articulo') }}" class="btn btn-light me-2">
                            <i class="bi bi-plus-lg me-1"></i> Añadir Artículo
                        </a>
                        <a href="{{ url_for('index') }}" class="btn btn-outline-light">
                            <i class="bi bi-arrow-left me-1"></i> Volver
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Cuadro de Búsqueda Mejorado -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text bg-light">
                                    <i class="bi bi-search"></i>
                                </span>
                                <input type="text" name="search" id="search-input" class="form-control"
                                       placeholder="Buscar por nombre de artículo..."
                                       value=""
                                       autocomplete="off">
                                <button type="button" id="clear-search" class="btn btn-outline-secondary d-none">
                                    <i class="bi bi-x-lg"></i> Limpiar
                                </button>
                            </div>
                            <small class="text-muted">
                                <span id="search-status">
                                    Total: <span class="badge bg-secondary">{{ articulos.total }}</span> artículos
                                </span>
                            </small>
                        </div>
                    </div>

                    <div class="table-responsive tabla-scroll">
                        <table class="table table-hover table-striped table-sm">
                            <thead class="table-dark">
                                <tr>
                                    <th scope="col">Código</th>
                                    <th scope="col">Nombre</th>
                                    <th scope="col">Precio Compra</th>
                                    <th scope="col">Precio Venta</th>
                                    <th scope="col">Stock Mínimo</th>
                                    <th scope="col">Categoría</th>
                                    <th scope="col">Marca</th>
                                    <th scope="col">Unidad</th>
                                    <th scope="col" class="acciones-columna">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="articulos-tbody">
                                {% if articulos.items %}
                                {% for articulo in articulos.items %}
                                <tr>
                                    <td>{{ articulo.codigo }}</td>
                                    <td>{{ articulo.nombre }}</td>
                                    <td>S/ {{ "%.2f"|format(articulo.precio_compra) }}</td>
                                    <td>S/ {{ "%.2f"|format(articulo.precio_venta) }}</td>
                                    <td>{{ articulo.stock_minimo }}</td>
                                    <td>{{ articulo.categoria_nombre or 'N/A' }}</td>
                                    <td>{{ articulo.marca_nombre or 'N/A' }}</td>
                                    <td>{{ articulo.unidad_abreviatura or articulo.unidad_nombre or 'N/A' }}</td>
                                    <td class="acciones-columna">
                                        <a href="{{ url_for('articulos_bp.edit_articulo', id_articulo=articulo.id_articulo) }}" class="btn btn-warning btn-sm me-2">Editar</a>
                                        <form action="{{ url_for('articulos_bp.delete_articulo', id_articulo=articulo.id_articulo) }}" method="POST" class="d-inline" onsubmit="return confirm('¿Estás seguro de que quieres eliminar este artículo?');">
                                            <button type="submit" class="btn btn-danger btn-sm">Eliminar</button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                                {% else %}
                                <tr>
                                    <td colspan="9" class="text-center text-muted">
                                        No hay artículos registrados.
                                    </td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Paginación (se ocultará con búsqueda en tiempo real) -->
                    <div id="pagination-section">
                        {% if articulos.items %}
                        <nav aria-label="Navegación de páginas">
                            <ul class="pagination justify-content-center mb-0">
                                <!-- Botón Primera Página -->
                                <li class="page-item {% if not articulos.has_prev %}disabled{% endif %}">
                                    <a class="page-link" href="{{ url_for('articulos_bp.list_articulos', page=1) }}">
                                        <i class="bi bi-chevron-double-left"></i>
                                    </a>
                                </li>

                                <!-- Botón Anterior -->
                                <li class="page-item {% if not articulos.has_prev %}disabled{% endif %}">
                                    <a class="page-link" href="{{ url_for('articulos_bp.list_articulos', page=articulos.prev_num) if articulos.has_prev else '#' }}">
                                        <i class="bi bi-chevron-left"></i>
                                    </a>
                                </li>

                                <!-- Números de página -->
                                {% for page_num in articulos.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                                    {% if page_num %}
                                        <li class="page-item {% if page_num == articulos.page %}active{% endif %}">
                                            <a class="page-link" href="{{ url_for('articulos_bp.list_articulos', page=page_num) }}">{{ page_num }}</a>
                                        </li>
                                    {% else %}
                                        <li class="page-item disabled">
                                            <span class="page-link">...</span>
                                        </li>
                                    {% endif %}
                                {% endfor %}

                                <!-- Botón Siguiente -->
                                <li class="page-item {% if not articulos.has_next %}disabled{% endif %}">
                                    <a class="page-link" href="{{ url_for('articulos_bp.list_articulos', page=articulos.next_num) if articulos.has_next else '#' }}">
                                        <i class="bi bi-chevron-right"></i>
                                    </a>
                                </li>

                                <!-- Botón Última Página -->
                                <li class="page-item {% if not articulos.has_next %}disabled{% endif %}">
                                    <a class="page-link" href="{{ url_for('articulos_bp.list_articulos', page=articulos.pages) }}">
                                        <i class="bi bi-chevron-double-right"></i>
                                    </a>
                                </li>
                            </ul>
                        </nav>

                        <!-- Información de paginación -->
                        <div class="text-center mt-3 text-muted">
                            <small>
                                Mostrando {{ articulos.items|length }} de {{ articulos.total }} artículos
                                (Página {{ articulos.page }} de {{ articulos.pages }})
                            </small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .acciones-columna {
        width: 200px;
    }

    .tabla-scroll {
        max-height: 450px;
        overflow-y: auto;
        margin-bottom: 1rem;
    }

    .table-sm {
        font-size: 0.875rem;
    }

    .table-sm td, .table-sm th {
        padding: 0.4rem;
        vertical-align: middle;
    }

    .tabla-scroll thead th {
        position: sticky;
        top: 0;
        z-index: 10;
        background-color: #212529;
        box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.4);
    }

    .pagination .page-link {
        color: #0d6efd;
    }

    .pagination .page-item.active .page-link {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }

    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
    }

    .input-group-text {
        border-right: 0;
    }

    #search-input {
        border-left: 0;
        border-right: 0;
    }

    #search-input:focus {
        box-shadow: none;
        border-color: #ced4da;
    }

    .tabla-scroll::-webkit-scrollbar {
        width: 8px;
    }

    .tabla-scroll::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    .tabla-scroll::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
    }

    .tabla-scroll::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    .badge {
        font-size: 0.75rem;
    }

    /* Estilos para el estado de carga */
    .search-loading {
        opacity: 0.7;
        pointer-events: none;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search-input');
    const clearSearchBtn = document.getElementById('clear-search');
    const searchStatus = document.getElementById('search-status');
    const articulosTbody = document.getElementById('articulos-tbody');
    const paginationSection = document.getElementById('pagination-section');

    let searchTimeout;
    let allArticulos = [];

    // Cargar todos los artículos al inicio (para búsqueda en tiempo real)
    function loadAllArticulos() {
        fetch('{{ url_for("articulos_bp.get_all_articulos") }}')
            .then(response => response.json())
            .then(data => {
                allArticulos = data.articulos || [];
            })
            .catch(error => {
                console.error('Error al cargar artículos:', error);
            });
    }

    // Función para filtrar artículos en tiempo real
    function filterArticulos(searchTerm) {
        if (!searchTerm.trim()) {
            // Si no hay término de búsqueda, mostrar todos los artículos de la página actual
            restoreOriginalView();
            return;
        }

        const searchLower = searchTerm.toLowerCase().trim();
        const filtered = allArticulos.filter(articulo =>
            articulo.nombre.toLowerCase().includes(searchLower) ||
            articulo.codigo.toLowerCase().includes(searchLower) ||
            (articulo.categoria_nombre && articulo.categoria_nombre.toLowerCase().includes(searchLower)) ||
            (articulo.marca_nombre && articulo.marca_nombre.toLowerCase().includes(searchLower))
        );

        updateTableView(filtered, searchTerm);
    }

    // Función para actualizar la vista de la tabla con resultados filtrados
    function updateTableView(articulos, searchTerm) {
        // Ocultar paginación durante la búsqueda
        paginationSection.style.display = 'none';

        if (articulos.length === 0) {
            articulosTbody.innerHTML = `
                <tr>
                    <td colspan="9" class="text-center text-muted">
                        <i class="bi bi-search me-2"></i>No se encontraron artículos con el término "${searchTerm}"
                    </td>
                </tr>
            `;
            searchStatus.innerHTML = `Resultados para "<strong>${searchTerm}</strong>": <span class="badge bg-warning">0</span> artículos encontrados`;
        } else {
            // Generar HTML para los artículos filtrados
            const html = articulos.map(articulo => `
                <tr>
                    <td>${articulo.codigo}</td>
                    <td>${articulo.nombre}</td>
                    <td>S/ ${articulo.precio_compra.toFixed(2)}</td>
                    <td>S/ ${articulo.precio_venta.toFixed(2)}</td>
                    <td>${articulo.stock_minimo}</td>
                    <td>${articulo.categoria_nombre || 'N/A'}</td>
                    <td>${articulo.marca_nombre || 'N/A'}</td>
                    <td>${articulo.unidad_abreviatura || articulo.unidad_nombre || 'N/A'}</td>
                    <td class="acciones-columna">
                        <a href="/articulos/edit/${articulo.id_articulo}" class="btn btn-warning btn-sm me-2">Editar</a>
                        <form action="/articulos/delete/${articulo.id_articulo}" method="POST" class="d-inline" onsubmit="return confirm('¿Estás seguro de que quieres eliminar este artículo?');">
                            <button type="submit" class="btn btn-danger btn-sm">Eliminar</button>
                        </form>
                    </td>
                </tr>
            `).join('');

            articulosTbody.innerHTML = html;
            searchStatus.innerHTML = `Resultados para "<strong>${searchTerm}</strong>": <span class="badge bg-primary">${articulos.length}</span> artículos encontrados`;
        }

        // Mostrar botón de limpiar
        clearSearchBtn.classList.remove('d-none');
    }

    // Función para restaurar la vista original
    function restoreOriginalView() {
        // Recargar la página para mostrar la vista original con paginación
        window.location.href = '{{ url_for("articulos_bp.list_articulos") }}';
    }

    // Event listener para búsqueda en tiempo real
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value;

        // Mostrar/ocultar botón de limpiar
        if (searchTerm.trim()) {
            clearSearchBtn.classList.remove('d-none');
        } else {
            clearSearchBtn.classList.add('d-none');
        }

        // Limpiar timeout anterior
        clearTimeout(searchTimeout);

        // Agregar clase de loading
        document.querySelector('.tabla-scroll').classList.add('search-loading');

        // Esperar 300ms después de que el usuario deje de escribir
        searchTimeout = setTimeout(() => {
            filterArticulos(searchTerm);
            // Quitar clase de loading
            document.querySelector('.tabla-scroll').classList.remove('search-loading');
        }, 300);
    });

    // Event listener para limpiar búsqueda
    clearSearchBtn.addEventListener('click', function() {
        searchInput.value = '';
        clearSearchBtn.classList.add('d-none');
        restoreOriginalView();
    });

    // Limpiar búsqueda con tecla ESC
    searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            this.value = '';
            clearSearchBtn.classList.add('d-none');
            restoreOriginalView();
        }
    });

    // Cargar todos los artículos al inicio
    loadAllArticulos();
});
</script>
{% endblock %}