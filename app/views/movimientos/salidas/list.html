{% extends "base.html" %}
{% from "macros/pagination.html" import render_pagination, render_pagination_info, render_per_page_selector %}
{% from "macros/busqueda.html" import articulo_search_component, articulo_search_scripts %}

{% block title %}Movimientos de Salida{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3"><i class="bi bi-box-arrow-up me-2"></i>Movimientos de Salida</h1>
        <div>
            <a href="{{ url_for('movimientos_bp.add_salida') }}" class="btn btn-primary me-2">
                <i class="bi bi-plus-circle me-1"></i> Nueva Salida
            </a>
            <a href="{{ url_for('index') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left me-1"></i> Volver
            </a>
        </div>
    </div>

    <!-- Buscador -->
    <!-- Búsqueda rápida de artículos (COMPACTA) -->
<div class="card mb-4">
    <div class="card-body py-2">
        <form method="GET" id="formBusquedaArticulo" class="row g-2 align-items-end">
            <div class="col-md-4">
                <label for="search_articulo" class="form-label small mb-1">Buscar Artículo:</label>
                <div class="input-group input-group-sm">
                    <input type="text" id="search_articulo" class="form-control form-control-sm"
                           placeholder="Código o nombre...">
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearSearch()">
                        <i class="bi bi-x-circle"></i>
                    </button>
                </div>
                <select id="id_articulo" name="id_articulo" class="form-select form-select-sm mt-1" required size="3" style="display: none;">
                    <option value="">Seleccionar artículo</option>
                    {% for articulo in articulos %}
                    <option value="{{ articulo.id_articulo }}"
                            data-codigo="{{ articulo.codigo }}"
                            data-nombre="{{ articulo.nombre }}">
                        {{ articulo.codigo }} - {{ articulo.nombre }}
                    </option>
                    {% endfor %}
                </select>
                <div id="articulo_seleccionado" class="mt-1 p-1 bg-light rounded small" style="display: none;">
                    <strong>Seleccionado:</strong>
                    <span id="articulo_info"></span>
                    <button type="button" class="btn btn-sm btn-outline-secondary ms-1 p-0" onclick="cambiarArticulo()" style="font-size: 0.7rem;">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
            </div>

            <div class="col-md-3">
                <label for="fecha_desde" class="form-label small mb-1">Fecha Desde:</label>
                <input type="date" id="fecha_desde" name="fecha_desde" class="form-control form-control-sm" value="{{ request.args.get('fecha_desde', '') }}">
            </div>

            <div class="col-md-3">
                <label for="fecha_hasta" class="form-label small mb-1">Fecha Hasta:</label>
                <input type="date" id="fecha_hasta" name="fecha_hasta" class="form-control form-control-sm" value="{{ request.args.get('fecha_hasta', '') }}">
            </div>

            <div class="col-md-2">
                <div class="d-flex gap-1">
                    <button type="submit" class="btn btn-primary btn-sm">
                        <i class="bi bi-filter me-1"></i> Filtrar
                    </button>
                    <a href="{{ url_for('movimientos_bp.list_entradas') }}" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-arrow-clockwise"></i>
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>

    <div class="card">
        <div class="card-body">
            <!-- Información de paginación y selector -->
            <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-3">
                <div>
                    {{ render_pagination_info(pagination) }}
                </div>
                <div>
                    {{ render_per_page_selector(pagination.per_page, 'movimientos_bp.list_salidas', search=search) }}
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-striped table-hover table-sm">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Fecha</th>
                            <th>Almacén</th>
                            <th>Tipo Movimiento</th>
                            <th>Usuario</th>
                            <th>Observaciones</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for movimiento in movimientos %}
                        <tr>
                            <td>{{ movimiento.id_movimiento_cabecera }}</td>
                            <td>{{ movimiento.fecha_movimiento.strftime('%d/%m/%Y %H:%M') }}</td>
                            <td>{{ movimiento.almacen_nombre }}</td>
                            <td>{{ movimiento.tipo_movimiento_nombre }}</td>
                            <td>{{ movimiento.nombre_usuario }}</td>
                            <td>{{ movimiento.observacion or 'Sin observaciones' }}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <a href="{{ url_for('movimientos_bp.detalle_movimiento', id_movimiento=movimiento.id_movimiento_cabecera) }}"
                                       class="btn btn-outline-primary" title="Ver detalle">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    <form action="{{ url_for('movimientos_bp.eliminar_movimiento', id_movimiento=movimiento.id_movimiento_cabecera) }}"
                                          method="post" class="d-inline"
                                          onsubmit="return confirm('¿Está seguro de eliminar este movimiento?');">
                                        <button type="submit" class="btn btn-outline-danger" title="Eliminar">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="7" class="text-center text-muted py-5">
                                <i class="bi bi-inbox fs-1 d-block mb-3 text-secondary"></i>
                                <strong>No hay movimientos de salida registrados</strong>
                                {% if search %}
                                <p class="mb-0 mt-2">No se encontraron resultados para "{{ search }}"</p>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Componente de paginación reutilizable -->
            {{ render_pagination(pagination, 'movimientos_bp.list_salidas', search=search) }}
        </div>
    </div>
</div>

<!-- Incluir scripts del componente de búsqueda -->
{{ articulo_search_scripts() }}

<script>
// Modificar el comportamiento para la lista de movimientos
document.addEventListener('DOMContentLoaded', function() {
    const selectArticulo = document.getElementById('id_articulo');
    const formBusquedaArticulo = document.getElementById('formBusquedaArticulo');

    // Sobrescribir el comportamiento del select para la lista
    selectArticulo.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption && selectedOption.value) {
            const codigo = selectedOption.getAttribute('data-codigo');
            const nombre = selectedOption.getAttribute('data-nombre');

            // Actualizar la información del artículo seleccionado
            document.getElementById('articulo_info').textContent = `${codigo} - ${nombre}`;
            document.getElementById('articulo_seleccionado').style.display = 'block';
            selectArticulo.style.display = 'none';
            document.getElementById('search_articulo').value = '';

            // Enviar el formulario automáticamente cuando se selecciona un artículo
            setTimeout(() => {
                formBusquedaArticulo.submit();
            }, 500);
        }
    });

    // También enviar el formulario cuando se presiona Enter en el buscador
    document.getElementById('search_articulo').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            formBusquedaArticulo.submit();
        }
    });
});

// Modificar las funciones para la lista
function clearSearch() {
    const searchInput = document.getElementById('search_articulo');
    const selectArticulo = document.getElementById('id_articulo');

    searchInput.value = '';
    searchInput.focus();
    filterArticulos('');
    selectArticulo.selectedIndex = 0;
    selectArticulo.style.display = 'block';
    document.getElementById('articulo_seleccionado').style.display = 'none';
}

function cambiarArticulo() {
    document.getElementById('articulo_seleccionado').style.display = 'none';
    document.getElementById('id_articulo').style.display = 'block';
    document.getElementById('id_articulo').selectedIndex = 0;
    document.getElementById('search_articulo').value = '';
    document.getElementById('search_articulo').focus();
    filterArticulos('');
}
</script>

<style>
/* Tabla compacta */
.table-sm td,
.table-sm th {
    padding: 0.4rem !important;
    font-size: 0.9rem;
}

/* Badges más pequeños */
.table-sm .badge {
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
}

/* Botones más pequeños */
.table-sm .btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

/* Estilos para el componente de búsqueda en lista */
#id_articulo {
    width: 100%;
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
}

#id_articulo option {
    padding: 8px 12px;
    border-bottom: 1px solid #f8f9fa;
    cursor: pointer;
}

#id_articulo option:hover {
    background-color: #e9ecef;
}

#id_articulo option:checked {
    background-color: #0d6efd;
    color: white;
}

#id_articulo .no-results {
    color: #6c757d !important;
    background-color: transparent !important;
    font-style: italic;
}

#search_articulo:focus {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

#articulo_seleccionado {
    border-left: 4px solid #198754;
    background-color: #f8fff9;
}
</style>
{% endblock %}