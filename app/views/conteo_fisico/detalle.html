{% extends "base.html" %}

{% block title %}Detalle de Conteo Físico{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3">
            <i class="bi bi-clipboard-data me-2"></i>Conteo Físico #{{ conteo.id_conteo }}
        </h1>
        <div>
            {% if conteo.estado != 'FINALIZADO' and conteo.estado != 'AJUSTADO' %}
            <button type="button" class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#modalAgregarArticulo">
                <i class="bi bi-plus-circle me-1"></i> Agregar Artículo
            </button>
            <form action="{{ url_for('conteo_fisico_bp.finalizar_conteo', id_conteo=conteo.id_conteo) }}"
                  method="post" class="d-inline">
                <button type="submit" class="btn btn-warning"
                        onclick="return confirm('¿Finalizar conteo? No podrá agregar más artículos.')">
                    <i class="bi bi-flag-fill me-1"></i> Finalizar Conteo
                </button>
            </form>
            {% endif %}
            <a href="{{ url_for('conteo_fisico_bp.list_conteos') }}" class="btn btn-secondary ms-2">
                <i class="bi bi-arrow-left me-1"></i> Volver
            </a>
        </div>
    </div>

    <!-- Información del Conteo -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Información del Conteo</h5>
                    <p><strong>Almacén:</strong> {{ conteo.almacen_nombre }}</p>
                    <p><strong>Fecha Inicio:</strong> {{ conteo.fecha_inicio.strftime('%d/%m/%Y %H:%M') }}</p>
                    <p><strong>Fecha Fin:</strong>
                        {% if conteo.fecha_fin %}
                        {{ conteo.fecha_fin.strftime('%d/%m/%Y %H:%M') }}
                        {% else %}
                        <span class="text-muted">En progreso</span>
                        {% endif %}
                    </p>
                    <p><strong>Responsable:</strong> {{ conteo.nombre_usuario }}</p>
                    <p><strong>Estado:</strong>
                        <span class="badge bg-{% if conteo.estado == 'PROGRAMADO' %}secondary{% elif conteo.estado == 'EN_CURSO' %}warning{% elif conteo.estado == 'FINALIZADO' %}info{% else %}success{% endif %}">
                            {{ conteo.estado }}
                        </span>
                    </p>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Resumen</h5>
                    <p><strong>Total Artículos:</strong> {{ detalle|length }}</p>
                    <p><strong>Artículos con Diferencia:</strong>
                        {{ detalle|selectattr('diferencia', '!=', 0)|list|length }}
                    </p>
                    {% if conteo.observaciones %}
                    <p><strong>Observaciones:</strong> {{ conteo.observaciones }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Detalle del Conteo -->
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Artículos Contados</h5>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Artículo</th>
                            <th>Código</th>
                            <th>Stock Sistema</th>
                            <th>Stock Contado</th>
                            <th>Diferencia</th>
                            <th>Valor Diferencia</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in detalle %}
                        <tr>
                            <td>{{ item.articulo_nombre }}</td>
                            <td>{{ item.codigo }}</td>
                            <td>{{ item.stock_sistema_al_contar }}</td>
                            <td>{{ item.stock_contado }}</td>
                            <td>
                                <span class="badge bg-{% if item.diferencia == 0 %}success{% elif item.diferencia > 0 %}info{% else %}danger{% endif %}">
                                    {{ item.diferencia }}
                                </span>
                            </td>
                            <td>S/ {{ "%.2f"|format(item.diferencia * item.precio_compra) }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6" class="text-center text-muted">
                                No hay artículos en este conteo. Agregue artículos usando el botón superior.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal para agregar artículo -->
<div class="modal fade" id="modalAgregarArticulo" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Agregar Artículo al Conteo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formAgregarArticulo">
                    <input type="hidden" name="id_conteo" value="{{ conteo.id_conteo }}">
                    <div class="mb-3">
                        <label for="id_articulo" class="form-label">Artículo:</label>
                        <select id="id_articulo" name="id_articulo" class="form-select" required>
                            <option value="">Seleccionar artículo</option>
                            {% for articulo in articulos %}
                            <option value="{{ articulo.id_articulo }}"
                                    data-stock="{% for stock in stock_actual %}{% if stock.id_articulo == articulo.id_articulo %}{{ stock.stock_actual }}{% endif %}{% endfor %}">
                                {{ articulo.nombre }} ({{ articulo.codigo }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="stock_sistema" class="form-label">Stock Sistema:</label>
                        <input type="number" id="stock_sistema" class="form-control" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="stock_contado" class="form-label">Stock Contado:</label>
                        <input type="number" id="stock_contado" name="stock_contado" class="form-control" required min="0">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnAgregarArticulo">Agregar</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Actualizar stock sistema cuando se selecciona artículo
    document.getElementById('id_articulo').addEventListener('change', function() {
        const stock = this.options[this.selectedIndex].getAttribute('data-stock');
        document.getElementById('stock_sistema').value = stock || 0;
        document.getElementById('stock_contado').value = stock || 0;
    });

    // Agregar artículo al conteo
    document.getElementById('btnAgregarArticulo').addEventListener('click', function() {
        const form = document.getElementById('formAgregarArticulo');
        const formData = new FormData(form);

        fetch('{{ url_for("conteo_fisico_bp.agregar_articulo_conteo") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('Error: ' + error);
        });
    });
});
</script>
{% endblock %}