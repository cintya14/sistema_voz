{% extends "base.html" %}

{% block title %}Detalle de Venta #{{ venta.id_venta }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3">
            <i class="bi bi-receipt me-2"></i>
            Venta #{{ venta.id_venta }}
        </h1>
        <div>
            {% if detalle and venta.estado == 'EMITIDA' %}
            <form action="{{ url_for('ventas_bp.procesar_venta', id_venta=venta.id_venta) }}"
                  method="post" class="d-inline me-2">
                <button type="submit" class="btn btn-success"
                        onclick="return confirm('¿Procesar venta y actualizar stock?')">
                    <i class="bi bi-check-circle me-1"></i> Procesar Venta
                </button>
            </form>
            {% endif %}
            <button type="button" class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#modalAgregarArticulo">
                <i class="bi bi-plus-circle me-1"></i> Agregar Artículo
            </button>
            <a href="{{ url_for('ventas_bp.list_ventas') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left me-1"></i> Volver
            </a>
        </div>
    </div>

    <!-- Información de la Venta -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Información de la Venta</h5>
                    <p><strong>Documento:</strong> {{ venta.tipo_documento_nombre }} {{ venta.serie_documento }}-{{ venta.numero_documento }}</p>
                    <p><strong>Fecha:</strong> {{ venta.fecha_emision.strftime('%d/%m/%Y %H:%M') }}</p>
                    <p><strong>Cliente:</strong> {{ venta.cliente_nombre or 'N/A' }}</p>
                    <p><strong>Usuario:</strong> {{ venta.nombre_usuario }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Totales</h5>
                    <p><strong>Total Gravado:</strong> S/ {{ "%.2f"|format(total_gravado) }}</p>
                    <p><strong>Total IGV:</strong> S/ {{ "%.2f"|format(total_igv) }}</p>
                    <p><strong>Total Venta:</strong> S/ {{ "%.2f"|format(total_venta) }}</p>
                    <p><strong>Estado:</strong>
                        <span class="badge bg-{% if venta.estado == 'EMITIDA' %}success{% elif venta.estado == 'ANULADA' %}danger{% else %}warning{% endif %}">
                            {{ venta.estado }}
                        </span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Detalle de la Venta -->
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Artículos de la Venta</h5>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Artículo</th>
                            <th>Código</th>
                            <th>Cantidad</th>
                            <th>Precio Unitario</th>
                            <th>IGV</th>
                            <th>Subtotal</th>
                            <th>Unidad</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in detalle %}
                        <tr>
                            <td>{{ item.articulo_nombre }}</td>
                            <td>{{ item.codigo }}</td>
                            <td>{{ item.cantidad }}</td>
                            <td>S/ {{ "%.2f"|format(item.precio_unitario) }}</td>
                            <td>{{ item.porcentaje_igv }}%</td>
                            <td>S/ {{ "%.2f"|format(item.subtotal) }}</td>
                            <td>{{ item.unidad_abreviatura }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="7" class="text-center text-muted">
                                No hay artículos en esta venta. Agregue artículos usando el botón superior.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    {% if detalle %}
                    <tfoot class="table-secondary">
                        <tr>
                            <td colspan="2"><strong>TOTALES</strong></td>
                            <td><strong>{{ detalle|sum(attribute='cantidad') }}</strong></td>
                            <td></td>
                            <td></td>
                            <td><strong>S/ {{ "%.2f"|format(total_venta) }}</strong></td>
                            <td></td>
                        </tr>
                    </tfoot>
                    {% endif %}
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal para agregar artículo -->
<div class="modal fade" id="modalAgregarArticulo" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Agregar Artículo a la Venta</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formAgregarArticulo">
                    <input type="hidden" name="id_venta" value="{{ venta.id_venta }}">
                    <div class="mb-3">
                        <label for="id_articulo" class="form-label">Artículo:</label>
                        <select id="id_articulo" name="id_articulo" class="form-select" required>
                            <option value="">Seleccionar artículo</option>
                            {% for articulo in articulos %}
                            <option value="{{ articulo.id_articulo }}" data-precio="{{ articulo.precio_venta }}">
                                {{ articulo.nombre }} ({{ articulo.codigo }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="cantidad" class="form-label">Cantidad:</label>
                        <input type="number" id="cantidad" name="cantidad" class="form-control" required min="1">
                    </div>
                    <div class="mb-3">
                        <label for="precio_unitario" class="form-label">Precio Unitario (S/):</label>
                        <input type="number" step="0.01" id="precio_unitario" name="precio_unitario" class="form-control" required min="0">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnAgregarArticulo">Agregar</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Actualizar precio unitario cuando se selecciona artículo
    document.getElementById('id_articulo').addEventListener('change', function() {
        const precio = this.options[this.selectedIndex].getAttribute('data-precio');
        document.getElementById('precio_unitario').value = precio || 0;
    });

    // Agregar artículo a la venta
    document.getElementById('btnAgregarArticulo').addEventListener('click', function() {
        const form = document.getElementById('formAgregarArticulo');
        const formData = new FormData(form);

        fetch('{{ url_for("ventas_bp.agregar_articulo_venta") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('Error: ' + error);
        });
    });
});
</script>
{% endblock %}